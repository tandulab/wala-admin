import{g as de,u as j,i as H,h as J,k as _,c as V,z as ue,l as R,m as T,B as me,C as K,s as G,_ as Z,a as w,d as l,e as y,p as M,t as _e,b as s,w as k,D as pe,r as u,o as b,j as fe,E as ge,n as O,G as ve,I as Ce,U as he,Q as be,J as Ee,K as xe,L as Te,v as P,f as we}from"../index55442.js";import{h as Y}from"./moment55442.js";import{Q as Ae}from"./QuestionsList55442.js";import{s as L,h as v}from"./loader55442.js";const ye={props:["campaign_detail"],setup(E){de(()=>{m.value=E.campaign_detail?E.campaign_detail.users_count:0});const a=j(),D=H(),e=J(),o=_(!1),r=_(),t=_(!1),m=_(),N=V(()=>a.getters[K.USER_COUNTER]),f=()=>{o.value=!0,D.require({group:"generate-users",header:"Genera utenze",message:"",icon:"",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times"})},x=async function(){const p={counter:+r.value,campaign_id:E.campaign_detail.id};await a.dispatch(R.GENERATE_USER_QUESTIONNAIRES,p).then(g=>{o.value=!1,r.value="",t.value=!1}).catch(g=>{T(e,g),t.value=!1})},I=function(){o.value=!1,r.value=""},C=function(){t.value=!0,x()},h=async function(){let p=`/campaigns/${E.campaign_detail.id}/download_excel_user_questionnaires`;L(a);try{const A=await me({method:"get",url:p,responseType:"blob",timeout:6e4});var g=new Blob([A.data],{type:A.headers["content-type"]});const S=document.createElement("a");S.href=window.URL.createObjectURL(g),S.download=`campagna_${E.campaign_detail.name.replace(/\s/g,"_").toLocaleLowerCase()}.xlsx`,S.click(),v(a)}catch(A){v(a),T(e,A)}};return ue(N,p=>{let g=p.counter+" utenze create con successo";p.counter==1&&(g="Un utenza creata con successo"),G(e,{message:g,title:""}),m.value=p.users_count}),{showDialog:o,genereteUsers:x,onGenereteUsers:f,counter:r,disableBtn:t,users_count:m,closeDialog:I,onConfirmDialog:C,downloadExcel:h}}};const De={class:"px-3 mb-6 pb-6 flex align-items-center justify-content-between"},Ne={key:0},Se={key:1},Ie=l("b",null,"1",-1),Ue={key:2},Ve={class:"w-full"},Re={class:"field col-8"},ke=l("label",{for:"counter"},"Quante utenze vuoi generare?",-1),Ge={class:"flex align-items-center justify-content-end col-12 mt-5"};function Me(E,a,D,e,o,r){const t=u("Button"),m=u("InputText"),N=u("ConfirmDialog");return b(),w(pe,null,[l("div",De,[l("div",null,[e.users_count==0?(b(),w("p",Ne,"Non \xE8 stata generata nessuna utenza.")):y("",!0),e.users_count==1?(b(),w("p",Se,[M("E' stata generata "),Ie,M(" utenza")])):y("",!0),e.users_count>1?(b(),w("p",Ue,[M(" Sono state generate "),l("b",null,_e(e.users_count),1),M(" utenze ")])):y("",!0)]),l("div",null,[s(t,{label:"Genera utenze",class:"p-button-outlined ml-3",onClick:a[0]||(a[0]=f=>e.onGenereteUsers())}),s(t,{label:"Scarica Excel",class:"p-button-outlined ml-3",disabled:e.users_count==0,onClick:a[1]||(a[1]=f=>e.downloadExcel())},null,8,["disabled"])])]),s(N,{group:"generate-users",visible:e.showDialog,class:"generate-users"},{message:k(()=>[l("div",Ve,[l("div",Re,[ke,s(m,{id:"counter",type:"number",modelValue:e.counter,"onUpdate:modelValue":a[2]||(a[2]=f=>e.counter=f),class:"w-full",min:"1"},null,8,["modelValue"])]),l("div",Ge,[s(t,{label:"Annulla",class:"mr-3 p-button-text",onClick:a[3]||(a[3]=f=>e.closeDialog())}),s(t,{label:"Conferma",class:"",onClick:a[4]||(a[4]=f=>e.onConfirmDialog()),disabled:!e.counter||e.counter<1||e.disableBtn},null,8,["disabled"])])])]),_:1},8,["visible"])],64)}const Ye=Z(ye,[["render",Me]]),Le={setup(){const E=_({icon:"pi pi-home",to:"/campagne"}),a=_(""),D=_([{label:""}]),e=fe(),o=j(),r=J(),t=_({}),m=_({}),N="6d503a06-958b-4f83-af8d-92e39ced2f74",f=_(File),x=_(!1),I=_(!1),C=_(!1),h=_(!1),p=H(),g=V(()=>o.getters[ve.CURRENT_COMPANIES]),A=V(()=>o.getters[Ce.CURRENT_AUDIENCES]),S=V(()=>o.getters[he.CURRENT_USERS]),d=V(()=>o.getters[K.CURRENT_CAMPAIGN]),i=V(()=>o.getters[be.CURRENT_QUESTIONS]),W=async function(){try{return await o.dispatch(Ee.FETCH_ALL_AUDIENCES)}catch(n){v(o),T(r,n)}},X=async function(){const n=new Map;n.set("roles","admin");try{return await o.dispatch(xe.FETCH_ALL_USERS,n)}catch(c){v(o),T(r,c)}},$=async function(){try{return await o.dispatch(Te.FETCH_ALL_CAMPAIGN_QUESTIONS,e.params.id+"")}catch{v(o)}},z=async function(){L(o);try{const n=await o.dispatch(R.FETCH_CAMPAIGN_DETAIL,e.params.id+"");return te(),v(o),n}catch(n){v(o),T(r,n)}},B=function(){const n=new FormData;m.value&&m.value.name&&n.append("campaign[logo]",m.value);let c=t.value.start_at!==""?Y(t.value.start_at,"DD/MM/YYYY").format("YYYY-MM-DD"):"",re=t.value.end_at!==""?Y(t.value.end_at,"DD/MM/YYYY").format("YYYY-MM-DD"):"";for(const U in t.value)U=="start_at"?n.append(`campaign[${U}]`,c):U=="end_at"?n.append(`campaign[${U}]`,re):n.append(`campaign[${U}]`,t.value[U]+"");return delete t.value.logo_url,n},ee=async function(){L(o);const n={campaign_id:t.value.id,formData:B()};try{const c=await o.dispatch(R.UPDATE_CAMPAIGN,n);return G(r,{message:"Campagna aggiornata correttamente.",title:""}),z(),O.replace({name:"campagne"}),v(o),c}catch(c){v(o),T(r,c)}},ae=async function(){L(o);const n={formData:B()};n.formData.append("campaign[template_questionnaire_id]",N);try{const c=await o.dispatch(R.CREATE_CAMPAIGN,n);return G(r,{message:"Campagna creata correttamente.",title:""}),O.replace({name:"campagne"}),v(o),c}catch(c){v(o),T(r,c)}},te=function(){t.value.id=d.value.id,t.value.name=d.value.name,t.value.start_at=Y.unix(d.value.start_at).format("DD/MM/YYYY"),t.value.end_at=Y.unix(d.value.end_at).format("DD/MM/YYYY"),t.value.audience_id=d.value.audience_id,t.value.finish_email_text_it=d.value.finish_email_text_it!=null?d.value.finish_email_text_it:"",t.value.intro_text_it=d.value.intro_text_it!=null?d.value.intro_text_it:"",t.value.welcome_email_text_it=d.value.welcome_email_text_it!=null?d.value.welcome_email_text_it:"",t.value.logo_url=d.value.logo_url,t.value.status=d.value.status},ne=function(){q()||F()||Q()||(a.value!=""&&t.value.id?ee():ae())},F=function(){var n,c;return((n=t.value)==null?void 0:n.start_at)==""||((c=t.value)==null?void 0:c.start_at)==null?C.value=!0:C.value=!1,C.value},Q=function(){var n,c;return((n=t.value)==null?void 0:n.end_at)==""||((c=t.value)==null?void 0:c.end_at)==null?h.value=!0:h.value=!1,h.value},q=function(){var n,c;return((n=t.value)==null?void 0:n.name)==""||((c=t.value)==null?void 0:c.name)==null?x.value=!0:x.value=!1,x.value},oe=n=>{t.value.logo_url="",m.value=n.files[0]},le=n=>{p.require({target:n.currentTarget,message:"Sei sicuro di voler mandare un recall agli utenti che non hanno ancora compilato il questionario?",icon:"pi pi-info-circle",acceptClass:"p-button-warning",accept:()=>{ce()}})},se=n=>{p.require({target:n.currentTarget,message:"Sei sicuro di voler inviare le credenziali?",icon:"pi pi-info-circle",acceptClass:"p-button-danger",accept:()=>{ie()}})},ie=async function(){await o.dispatch(R.SEND_CREDENTIALS,t.value.id).then(()=>{G(r,{message:"Credenziali inviate correttamente.",title:""})}).catch(n=>{T(r,n)})},ce=async function(){await o.dispatch(R.SEND_RECALL,t.value.id).then(()=>{G(r,{message:"Recall inviato correttamente.",title:""})}).catch(n=>{T(r,n)})};return ge(async()=>{W(),X(),a.value=e.params.id+"",a.value!=""?(z(),$(),D.value[0]={label:"Modifica campagna"}):D.value[0]={label:"Nuova campagna"}}),{campaign_detail:d,home:E,items:D,response_companies:g,response_audiences:A,users:S,tmp_campaign:t,invalid_name:x,invalid_company:I,invalid_start_at:C,invalid_end_at:h,uploadedFile:m,file:f,campaign_questions:i,saveCampaign:ne,validateStartAt:F,validateEndAt:Q,validateName:q,confirmSendQuestionnaire:se,onSelectedFiles:oe,confirmSendRecall:le}},components:{QuestionsList:Ae,GeneratesUsersTab:Ye}};const Pe={class:"m-4"},ze={class:"flex align-items-center justify-content-between"},Be=l("h1",null,"CAMPAGNA",-1),Fe={key:0},Qe={class:"formgrid grid col-10"},qe={class:"field col-6"},Oe=l("label",{for:"name"},"Nome campagna*",-1),je={key:0,id:"name",class:"p-error"},He={class:"field col-3"},Je=l("label",{for:"audience"},"Audience",-1),Ke={class:"flex align-items-center col-3 pl-3"},Ze=l("label",{for:"excel",class:"ml-2"},"Genera accessi in Excel ",-1),We=l("div",{class:"field col-6"},null,-1),Xe={class:"my-0 col-12 flex flex-wrap mx-0"},$e={class:"field col-6 flex flex-column pl-0"},ea=l("label",{for:"start_at"},"Data inizio*",-1),aa={key:0,id:"end_at",class:"p-error"},ta={class:"field col-6 flex flex-column pr-0"},na=l("label",{for:"end_at"},"Data fine*",-1),oa={key:0,id:"end_at",class:"p-error"},la={class:"my-0 col-12 flex flex-wrap mx-0"},sa={class:"field col-6 pl-0"},ia=l("label",{for:"note"},"Intro questionario",-1),ca={class:"field col-6 pl-0"},ra=l("label",{for:"note"},"Intro email",-1),da={class:"field col-6 pl-0"},ua=l("label",{for:"note"},"Fine email",-1),ma={class:"flex justify-content-end"};function _a(E,a,D,e,o,r){const t=u("Breadcrumb"),m=u("Button"),N=u("InputText"),f=u("Dropdown"),x=u("Checkbox"),I=u("Calendar"),C=u("Textarea"),h=u("TabPanel"),p=u("QuestionsList"),g=u("GeneratesUsersTab"),A=u("TabView"),S=u("Card"),d=u("ConfirmPopup");return b(),w("div",Pe,[s(t,{home:e.home,model:e.items,class:"mb-3 mt-0 pt-0"},null,8,["home","model"]),s(S,null,{content:k(()=>[l("div",ze,[Be,e.tmp_campaign.id&&e.tmp_campaign.status!="finished"?(b(),w("div",Fe,[s(m,{label:"INVIA RECALL",class:"p-button-outlined p-button-warning mr-3",onClick:a[0]||(a[0]=i=>e.confirmSendRecall(i))}),s(m,{label:"INVIA CREDENZIALI",class:"p-button-outlined p-button-danger",onClick:a[1]||(a[1]=i=>e.confirmSendQuestionnaire(i))})])):y("",!0)]),s(A,null,{default:k(()=>[s(h,{header:"Dati campagna"},{default:k(()=>[l("div",Qe,[l("div",qe,[Oe,s(N,{id:"name",type:"text",modelValue:e.tmp_campaign.name,"onUpdate:modelValue":a[2]||(a[2]=i=>e.tmp_campaign.name=i),class:P(["w-full",{"p-invalid":e.invalid_name}]),onChange:e.validateName},null,8,["modelValue","class","onChange"]),e.invalid_name?(b(),w("small",je,"Campo obbligatorio.")):y("",!0)]),l("div",He,[Je,s(f,{modelValue:e.tmp_campaign.audience_id,"onUpdate:modelValue":a[3]||(a[3]=i=>e.tmp_campaign.audience_id=i),options:e.response_audiences.audiences,optionLabel:"name",optionValue:"id",id:"audience",class:"w-full",disabled:e.tmp_campaign.excel},null,8,["modelValue","options","disabled"])]),l("div",Ke,[s(x,{modelValue:e.tmp_campaign.excel,"onUpdate:modelValue":a[4]||(a[4]=i=>e.tmp_campaign.excel=i),inputId:"excel",binary:!0},null,8,["modelValue"]),Ze]),We,l("div",Xe,[l("div",$e,[ea,s(I,{inputId:"dateformat",modelValue:e.tmp_campaign.start_at,"onUpdate:modelValue":a[5]||(a[5]=i=>e.tmp_campaign.start_at=i),dateFormat:"dd/mm/yy",manualInput:!1,placeholder:"gg/mm/aaaa",id:"start_at",class:P({"p-invalid":e.invalid_start_at}),onChange:e.validateStartAt},null,8,["modelValue","class","onChange"]),e.invalid_start_at?(b(),w("small",aa,"Campo obbligatorio.")):y("",!0)]),l("div",ta,[na,s(I,{inputId:"dateformat",modelValue:e.tmp_campaign.end_at,"onUpdate:modelValue":a[6]||(a[6]=i=>e.tmp_campaign.end_at=i),dateFormat:"dd/mm/yy",manualInput:!1,placeholder:"gg/mm/aaaa",id:"end_at",class:P({"p-invalid":e.invalid_end_at}),onChange:e.validateEndAt},null,8,["modelValue","class","onChange"]),e.invalid_end_at?(b(),w("small",oa,"Campo obbligatorio.")):y("",!0)])]),l("div",la,[l("div",sa,[ia,s(C,{id:"note",modelValue:e.tmp_campaign.intro_text_it,"onUpdate:modelValue":a[7]||(a[7]=i=>e.tmp_campaign.intro_text_it=i),rows:"5",cols:"30",class:"w-full"},null,8,["modelValue"])]),l("div",ca,[ra,s(C,{id:"note",modelValue:e.tmp_campaign.welcome_email_text_it,"onUpdate:modelValue":a[8]||(a[8]=i=>e.tmp_campaign.welcome_email_text_it=i),rows:"5",cols:"30",class:"w-full"},null,8,["modelValue"])]),l("div",da,[ua,s(C,{id:"note",modelValue:e.tmp_campaign.finish_email_text_it,"onUpdate:modelValue":a[9]||(a[9]=i=>e.tmp_campaign.finish_email_text_it=i),rows:"5",cols:"30",class:"w-full"},null,8,["modelValue"])])])])]),_:1}),s(h,{header:"Domande",disabled:!e.tmp_campaign.id},{default:k(()=>[s(p,{questions:e.campaign_questions},null,8,["questions"])]),_:1},8,["disabled"]),s(h,{header:"Genera utenze",disabled:!e.tmp_campaign.id},{default:k(()=>[e.campaign_detail.id?(b(),we(g,{key:0,campaign_detail:e.campaign_detail},null,8,["campaign_detail"])):y("",!0)]),_:1},8,["disabled"])]),_:1}),l("div",ma,[s(m,{label:"Salva",onClick:e.saveCampaign},null,8,["onClick"])])]),_:1}),s(d)])}const Ca=Z(Le,[["render",_a]]);export{Ca as default};
