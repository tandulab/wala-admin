import{g as ue,u as H,i as J,h as K,k as _,c as V,z as me,l as R,m as T,B as _e,C as Z,s as G,_ as W,a as A,d as l,e as w,p as M,t as pe,b as s,w as k,D as fe,r as u,o as C,j as ge,E as ve,n as O,G as Ce,I as he,U as be,Q as xe,J as Ee,K as Te,L as we,v as P,f as j}from"../index74907.js";import{h as Y}from"./moment74907.js";import{Q as Ae}from"./QuestionsList74907.js";import{s as L,h as v}from"./loader74907.js";const ye={props:["campaign_detail"],setup(x){ue(()=>{m.value=x.campaign_detail?x.campaign_detail.users_count:0});const t=H(),D=J(),e=K(),o=_(!1),r=_(),a=_(!1),m=_(),N=V(()=>t.getters[Z.USER_COUNTER]),f=()=>{o.value=!0,D.require({group:"generate-users",header:"Genera utenze",message:"",icon:"",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times"})},E=async function(){const p={counter:+r.value,campaign_id:x.campaign_detail.id};await t.dispatch(R.GENERATE_USER_QUESTIONNAIRES,p).then(g=>{o.value=!1,r.value="",a.value=!1}).catch(g=>{T(e,g),a.value=!1})},I=function(){o.value=!1,r.value=""},h=function(){a.value=!0,E()},b=async function(){let p=`/campaigns/${x.campaign_detail.id}/download_excel_user_questionnaires`;L(t);try{const y=await _e({method:"get",url:p,responseType:"blob",timeout:6e4});var g=new Blob([y.data],{type:y.headers["content-type"]});const S=document.createElement("a");S.href=window.URL.createObjectURL(g),S.download=`campagna_${x.campaign_detail.name.replace(/\s/g,"_").toLocaleLowerCase()}.xlsx`,S.click(),v(t)}catch(y){v(t),T(e,y)}};return me(N,p=>{let g=p.counter+" utenze create con successo";p.counter==1&&(g="Un utenza creata con successo"),G(e,{message:g,title:""}),m.value=p.users_count}),{showDialog:o,genereteUsers:E,onGenereteUsers:f,counter:r,disableBtn:a,users_count:m,closeDialog:I,onConfirmDialog:h,downloadExcel:b}}};const De={class:"px-3 mb-6 pb-6 flex align-items-center justify-content-between"},Ne={key:0},Se={key:1},Ie=l("b",null,"1",-1),Ue={key:2},Ve={class:"w-full"},Re={class:"field col-8"},ke=l("label",{for:"counter"},"Quante utenze vuoi generare?",-1),Ge={class:"flex align-items-center justify-content-end col-12 mt-5"};function Me(x,t,D,e,o,r){const a=u("Button"),m=u("InputText"),N=u("ConfirmDialog");return C(),A(fe,null,[l("div",De,[l("div",null,[e.users_count==0?(C(),A("p",Ne,"Non \xE8 stata generata nessuna utenza.")):w("",!0),e.users_count==1?(C(),A("p",Se,[M("E' stata generata "),Ie,M(" utenza")])):w("",!0),e.users_count>1?(C(),A("p",Ue,[M(" Sono state generate "),l("b",null,pe(e.users_count),1),M(" utenze ")])):w("",!0)]),l("div",null,[s(a,{label:"Genera utenze",class:"p-button-outlined ml-3",onClick:t[0]||(t[0]=f=>e.onGenereteUsers())}),s(a,{label:"Scarica Excel",class:"p-button-outlined ml-3",disabled:e.users_count==0,onClick:t[1]||(t[1]=f=>e.downloadExcel())},null,8,["disabled"])])]),s(N,{group:"generate-users",visible:e.showDialog,class:"generate-users"},{message:k(()=>[l("div",Ve,[l("div",Re,[ke,s(m,{id:"counter",type:"number",modelValue:e.counter,"onUpdate:modelValue":t[2]||(t[2]=f=>e.counter=f),class:"w-full",min:"1"},null,8,["modelValue"])]),l("div",Ge,[s(a,{label:"Annulla",class:"mr-3 p-button-text",onClick:t[3]||(t[3]=f=>e.closeDialog())}),s(a,{label:"Conferma",class:"",onClick:t[4]||(t[4]=f=>e.onConfirmDialog()),disabled:!e.counter||e.counter<1||e.disableBtn},null,8,["disabled"])])])]),_:1},8,["visible"])],64)}const Ye=W(ye,[["render",Me]]),Le={setup(){const x=_({icon:"pi pi-home",to:"/campagne"}),t=_(""),D=_([{label:""}]),e=ge(),o=H(),r=K(),a=_({}),m=_({}),N="6d503a06-958b-4f83-af8d-92e39ced2f74",f=_(File),E=_(!1),I=_(!1),h=_(!1),b=_(!1),p=J(),g=V(()=>o.getters[Ce.CURRENT_COMPANIES]),y=V(()=>o.getters[he.CURRENT_AUDIENCES]),S=V(()=>o.getters[be.CURRENT_USERS]),d=V(()=>o.getters[Z.CURRENT_CAMPAIGN]),i=V(()=>o.getters[xe.CURRENT_QUESTIONS]),X=async function(){try{return await o.dispatch(Ee.FETCH_ALL_AUDIENCES)}catch(n){v(o),T(r,n)}},$=async function(){const n=new Map;n.set("roles","admin");try{return await o.dispatch(Te.FETCH_ALL_USERS,n)}catch(c){v(o),T(r,c)}},ee=async function(){try{return await o.dispatch(we.FETCH_ALL_CAMPAIGN_QUESTIONS,e.params.id+"")}catch{v(o)}},z=async function(){L(o);try{const n=await o.dispatch(R.FETCH_CAMPAIGN_DETAIL,e.params.id+"");return ne(),v(o),n}catch(n){v(o),T(r,n)}},B=function(){const n=new FormData;m.value&&m.value.name&&n.append("campaign[logo]",m.value);let c=a.value.start_at!==""?Y(a.value.start_at,"DD/MM/YYYY").format("YYYY-MM-DD"):"",de=a.value.end_at!==""?Y(a.value.end_at,"DD/MM/YYYY").format("YYYY-MM-DD"):"";for(const U in a.value)U=="start_at"?n.append(`campaign[${U}]`,c):U=="end_at"?n.append(`campaign[${U}]`,de):n.append(`campaign[${U}]`,a.value[U]+"");return delete a.value.logo_url,n},ae=async function(){L(o);const n={campaign_id:a.value.id,formData:B()};try{const c=await o.dispatch(R.UPDATE_CAMPAIGN,n);return G(r,{message:"Campagna aggiornata correttamente.",title:""}),z(),O.replace({name:"campagne"}),v(o),c}catch(c){v(o),T(r,c)}},te=async function(){L(o);const n={formData:B()};n.formData.append("campaign[template_questionnaire_id]",N);try{const c=await o.dispatch(R.CREATE_CAMPAIGN,n);return G(r,{message:"Campagna creata correttamente.",title:""}),O.replace({name:"campagne"}),v(o),c}catch(c){v(o),T(r,c)}},ne=function(){a.value.id=d.value.id,a.value.name=d.value.name,a.value.start_at=Y.unix(d.value.start_at).format("DD/MM/YYYY"),a.value.end_at=Y.unix(d.value.end_at).format("DD/MM/YYYY"),a.value.audience_id=d.value.audience_id,a.value.finish_email_text_it=d.value.finish_email_text_it!=null?d.value.finish_email_text_it:"",a.value.intro_text_it=d.value.intro_text_it!=null?d.value.intro_text_it:"",a.value.welcome_email_text_it=d.value.welcome_email_text_it!=null?d.value.welcome_email_text_it:"",a.value.logo_url=d.value.logo_url,a.value.status=d.value.status,a.value.excel=d.value.excel},oe=function(){q()||F()||Q()||(t.value!=""&&a.value.id?ae():te())},F=function(){var n,c;return((n=a.value)==null?void 0:n.start_at)==""||((c=a.value)==null?void 0:c.start_at)==null?h.value=!0:h.value=!1,h.value},Q=function(){var n,c;return((n=a.value)==null?void 0:n.end_at)==""||((c=a.value)==null?void 0:c.end_at)==null?b.value=!0:b.value=!1,b.value},q=function(){var n,c;return((n=a.value)==null?void 0:n.name)==""||((c=a.value)==null?void 0:c.name)==null?E.value=!0:E.value=!1,E.value},le=n=>{a.value.logo_url="",m.value=n.files[0]},se=n=>{p.require({target:n.currentTarget,message:"Sei sicuro di voler mandare un recall agli utenti che non hanno ancora compilato il questionario?",icon:"pi pi-info-circle",acceptClass:"p-button-warning",accept:()=>{re()}})},ie=n=>{p.require({target:n.currentTarget,message:"Sei sicuro di voler inviare le credenziali?",icon:"pi pi-info-circle",acceptClass:"p-button-danger",accept:()=>{ce()}})},ce=async function(){await o.dispatch(R.SEND_CREDENTIALS,a.value.id).then(()=>{G(r,{message:"Credenziali inviate correttamente.",title:""})}).catch(n=>{T(r,n)})},re=async function(){await o.dispatch(R.SEND_RECALL,a.value.id).then(()=>{G(r,{message:"Recall inviato correttamente.",title:""})}).catch(n=>{T(r,n)})};return ve(async()=>{X(),$(),t.value=e.params.id+"",t.value!=""?(z(),ee(),D.value[0]={label:"Modifica campagna"}):D.value[0]={label:"Nuova campagna"}}),{campaign_detail:d,home:x,items:D,response_companies:g,response_audiences:y,users:S,tmp_campaign:a,invalid_name:E,invalid_company:I,invalid_start_at:h,invalid_end_at:b,uploadedFile:m,file:f,campaign_questions:i,saveCampaign:oe,validateStartAt:F,validateEndAt:Q,validateName:q,confirmSendQuestionnaire:ie,onSelectedFiles:le,confirmSendRecall:se}},components:{QuestionsList:Ae,GeneratesUsersTab:Ye}};const Pe={class:"m-4"},ze={class:"flex align-items-center justify-content-between"},Be=l("h1",null,"CAMPAGNA",-1),Fe={key:0},Qe={class:"formgrid grid col-10"},qe={class:"field col-6"},Oe=l("label",{for:"name"},"Nome campagna*",-1),je={key:0,id:"name",class:"p-error"},He={class:"field col-3"},Je=l("label",{for:"audience"},"Audience",-1),Ke={class:"flex align-items-center col-3 pl-3"},Ze=l("label",{for:"excel",class:"ml-2"},"Genera accessi in Excel ",-1),We=l("div",{class:"field col-6"},null,-1),Xe={class:"my-0 col-12 flex flex-wrap mx-0"},$e={class:"field col-6 flex flex-column pl-0"},ea=l("label",{for:"start_at"},"Data inizio*",-1),aa={key:0,id:"end_at",class:"p-error"},ta={class:"field col-6 flex flex-column pr-0"},na=l("label",{for:"end_at"},"Data fine*",-1),oa={key:0,id:"end_at",class:"p-error"},la={class:"my-0 col-12 flex flex-wrap mx-0"},sa={class:"field col-6 pl-0"},ia=l("label",{for:"note"},"Intro questionario",-1),ca={class:"field col-6 pl-0"},ra=l("label",{for:"note"},"Intro email",-1),da={class:"field col-6 pl-0"},ua=l("label",{for:"note"},"Fine email",-1),ma={class:"flex justify-content-end"};function _a(x,t,D,e,o,r){const a=u("Breadcrumb"),m=u("Button"),N=u("InputText"),f=u("Dropdown"),E=u("Checkbox"),I=u("Calendar"),h=u("Textarea"),b=u("TabPanel"),p=u("QuestionsList"),g=u("GeneratesUsersTab"),y=u("TabView"),S=u("Card"),d=u("ConfirmPopup");return C(),A("div",Pe,[s(a,{home:e.home,model:e.items,class:"mb-3 mt-0 pt-0"},null,8,["home","model"]),s(S,null,{content:k(()=>[l("div",ze,[Be,e.tmp_campaign.id&&e.tmp_campaign.status!="finished"?(C(),A("div",Fe,[s(m,{label:"INVIA RECALL",class:"p-button-outlined p-button-warning mr-3",onClick:t[0]||(t[0]=i=>e.confirmSendRecall(i))}),s(m,{label:"INVIA CREDENZIALI",class:"p-button-outlined p-button-danger",onClick:t[1]||(t[1]=i=>e.confirmSendQuestionnaire(i))})])):w("",!0)]),s(y,null,{default:k(()=>[s(b,{header:"Dati campagna"},{default:k(()=>[l("div",Qe,[l("div",qe,[Oe,s(N,{id:"name",type:"text",modelValue:e.tmp_campaign.name,"onUpdate:modelValue":t[2]||(t[2]=i=>e.tmp_campaign.name=i),class:P(["w-full",{"p-invalid":e.invalid_name}]),onChange:e.validateName},null,8,["modelValue","class","onChange"]),e.invalid_name?(C(),A("small",je,"Campo obbligatorio.")):w("",!0)]),l("div",He,[Je,s(f,{modelValue:e.tmp_campaign.audience_id,"onUpdate:modelValue":t[3]||(t[3]=i=>e.tmp_campaign.audience_id=i),options:e.response_audiences.audiences,optionLabel:"name",optionValue:"id",id:"audience",class:"w-full",disabled:e.tmp_campaign.excel},null,8,["modelValue","options","disabled"])]),l("div",Ke,[s(E,{modelValue:e.tmp_campaign.excel,"onUpdate:modelValue":t[4]||(t[4]=i=>e.tmp_campaign.excel=i),inputId:"excel",binary:!0},null,8,["modelValue"]),Ze]),We,l("div",Xe,[l("div",$e,[ea,s(I,{inputId:"dateformat",modelValue:e.tmp_campaign.start_at,"onUpdate:modelValue":t[5]||(t[5]=i=>e.tmp_campaign.start_at=i),dateFormat:"dd/mm/yy",manualInput:!1,placeholder:"gg/mm/aaaa",id:"start_at",class:P({"p-invalid":e.invalid_start_at}),onChange:e.validateStartAt},null,8,["modelValue","class","onChange"]),e.invalid_start_at?(C(),A("small",aa,"Campo obbligatorio.")):w("",!0)]),l("div",ta,[na,s(I,{inputId:"dateformat",modelValue:e.tmp_campaign.end_at,"onUpdate:modelValue":t[6]||(t[6]=i=>e.tmp_campaign.end_at=i),dateFormat:"dd/mm/yy",manualInput:!1,placeholder:"gg/mm/aaaa",id:"end_at",class:P({"p-invalid":e.invalid_end_at}),onChange:e.validateEndAt},null,8,["modelValue","class","onChange"]),e.invalid_end_at?(C(),A("small",oa,"Campo obbligatorio.")):w("",!0)])]),l("div",la,[l("div",sa,[ia,s(h,{id:"note",modelValue:e.tmp_campaign.intro_text_it,"onUpdate:modelValue":t[7]||(t[7]=i=>e.tmp_campaign.intro_text_it=i),rows:"5",cols:"30",class:"w-full"},null,8,["modelValue"])]),l("div",ca,[ra,s(h,{id:"note",modelValue:e.tmp_campaign.welcome_email_text_it,"onUpdate:modelValue":t[8]||(t[8]=i=>e.tmp_campaign.welcome_email_text_it=i),rows:"5",cols:"30",class:"w-full"},null,8,["modelValue"])]),l("div",da,[ua,s(h,{id:"note",modelValue:e.tmp_campaign.finish_email_text_it,"onUpdate:modelValue":t[9]||(t[9]=i=>e.tmp_campaign.finish_email_text_it=i),rows:"5",cols:"30",class:"w-full"},null,8,["modelValue"])])])])]),_:1}),s(b,{header:"Domande",disabled:!e.tmp_campaign.id},{default:k(()=>[s(p,{questions:e.campaign_questions},null,8,["questions"])]),_:1},8,["disabled"]),e.tmp_campaign.excel?(C(),j(b,{key:0,header:"Genera utenze",disabled:!e.tmp_campaign.id},{default:k(()=>[e.campaign_detail.id?(C(),j(g,{key:0,campaign_detail:e.campaign_detail},null,8,["campaign_detail"])):w("",!0)]),_:1},8,["disabled"])):w("",!0)]),_:1}),l("div",ma,[s(m,{label:"Salva",onClick:e.saveCampaign},null,8,["onClick"])])]),_:1}),s(d)])}const Ca=W(Le,[["render",_a]]);export{Ca as default};
